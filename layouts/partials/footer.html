{{ "<!-- Footer -->" | safeHTML}}
  <footer id="footer">
    <ul class="icons">
      {{ range .Site.Params.links }}
      {{ $pack := or .icon_pack "fa" }}
        <li>
          <a href="{{ .link | safeURL }}" target="_blank" ><i class="icon {{ $pack }} {{ .icon }}"><span class="label">{{ .service }}</span></i></a>
        </li>
      {{ end }} {{/* range */}}
    </ul>
    <ul class="copyright">
      {{- range .Site.Params.Footer.copyright -}}
      <li>{{ . | markdownify }}</li>
      {{- end -}}
    </ul>
  </footer>

</div>
{{ "<!-- Scripts -->" | safeHTML }}
{{ $js := .Site.Data.libs.js }}
{{ $jquery := resources.Get "js/jquery.min.js" | fingerprint }}
{{ $dropotron := resources.Get "js/jquery.dropotron.min.js" | fingerprint }}
{{ $scrollex := resources.Get "js/jquery.scrollex.min.js" | fingerprint }}
{{ $browser := resources.Get "js/browser.min.js" | fingerprint }}
{{ $breakpoints := resources.Get "js/breakpoints.min.js" | fingerprint }}
{{ $util := resources.Get "js/util.js" | minify | fingerprint }}
{{ $bible := resources.Get "js/reftagger.js" | minify | fingerprint }}
{{ $ie := resources.Get "js/ie/respond.min.js" | minify | fingerprint }}
{{ $main := resources.Get "js/main.js" | minify | fingerprint }}
{{ $maps := resources.Get "/js/osmaps.init.js" | minify | fingerprint }}
{{/*TODO Figure out how/what hugo is doing with the other JS libraries with these named imports*/}}
<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script type="text/javascript">
    console.log("Doing anything");
    function identityStuff() {
        console.log("Applying callback to login")
        const user = netlifyIdentity.currentUser();
        netlifyIdentity.on('login', user => console.log('login', user));
        netlifyIdentity.on('init', user => console.log('init', user));

        console.log(user);
        var stripeCustomerId;
        if (user !== null) {
            console.log("We're ready to do some user stuff!");
            $.ajax({
                url: '/.netlify/functions/find-stripe-customer',
                type: 'GET',
                contentType: 'application/json',
                data: {
                    email: user.email
                },
                success: function (result) {
                    console.log("Success Find Customer!");
                    console.log(result);
                    let resultJson = JSON.parse(result);
                    console.log("resultJson: " + resultJson);
                    console.log("resultJson.ID: " + resultJson.ID);
                    stripeCustomerId = resultJson.ID;
                    // CallBack(result);

                    let stripeData = {
                        data: {
                            stripe_customer_id: stripeCustomerId
                        }
                    };
                    console.log("There is an existing Stripe customer, so we'll attach it to Identity user.")
                    $.ajax({
                        url: '/.netlify/identity/user',
                        type: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(stripeData),
                        headers: {
                            'Authorization': 'Bearer ' + user.token.access_token
                        },
                        success: function (result) {
                            console.log("Success PUT!");
                            console.log(result);
                            // CallBack(result);
                        },
                        error: function (error) {
                            console.log("Failure PUT!");
                            console.log(error);

                        }
                    });
                    $.ajax({
                        url: '/.netlify/identity/user',
                        type: 'GET',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': 'Bearer ' + user.token.access_token
                        },
                        success: function (result) {
                            console.log("Success GET!");
                            console.log(result);
                            // CallBack(result);
                        },
                        error: function (error) {
                            console.log("Failure GET!");
                            console.log(error);

                        }
                    });
                },
                error: function (error) {
                    console.log("Failure Find Customer!");
                    console.log(error);
                    stripeCustomerId = "";

                }
            });
            if (stripeCustomerId) {

            }
        }

    }

    window.onload = identityStuff;
</script>
{{ $plyr := resources.Get "/js/plyr.init.js" | minify | fingerprint }}
{{ "<!-- Scripts-HTML5up -->" | safeHTML }}
<script src="{{ $jquery.RelPermalink }}" integrity="{{ $jquery.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $dropotron.RelPermalink }}" integrity="{{ $dropotron.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $scrollex.RelPermalink }}" integrity="{{ $scrollex.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $browser.RelPermalink }}" integrity="{{ $browser.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $breakpoints.RelPermalink }}" integrity="{{ $breakpoints.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $util.RelPermalink }}" integrity="{{ $util.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="{{ $main.RelPermalink }}" integrity="{{ $main.Data.Integrity }}" crossorigin="anonymous"></script>
<script src="https://js.stripe.com/v3/"></script>
{{ "<!-- Scripts ALPHA-CHURCH-->" | safeHTML }}
{{ if .Site.Params.bible_popups }}<script src="{{ $bible.RelPermalink }}" integrity="{{ $bible.Data.Integrity }}" crossorigin="anonymous"></script>{{ end }}
{{ `<!--[if lte IE 8]><script src=" {{ $ie.RelPermalink }} "></script><![endif]-->` | safeHTML}}
<script src="{{ $maps.RelPermalink }}" integrity="{{ $maps.Data.Integrity }}" crossorigin="anonymous"></script>
{{ if .IsPage }}<script src="{{ $plyr.RelPermalink }}" integrity="{{ $plyr.Data.Integrity }}" crossorigin="anonymous"></script>{{ end }}
{{ printf "<script src=\"//unpkg.com/leaflet@%s/dist/leaflet.js\" integrity=\"%s\" crossorigin=\"anonymous\"></script>" $js.leaflet.version $js.leaflet.integrity | safeHTML }}
{{ if $.IsPage }}{{ printf "<script src=\"//cdn.plyr.io/%s/plyr.polyfilled.js\" integrity=\"%s\" crossorigin=\"anonymous\"></script>" $js.plyr.version $js.plyr.integrity | safeHTML }}{{ end }}
{{ if .Site.GoogleAnalytics }}{{ template "_internal/google_analytics_async.html" . }}{{ end }}
{{ if .Site.Params.instant_page }}{{ printf "<script src=\"//instant.page/%s\" type=\"module\" integrity=\"%s\" crossorigin=\"anonymous\"></script>" $js.instantpage.version $js.instantpage.integrity | safeHTML }}{{ end }}
</body>
</html>
